# åˆ†å¸ƒå¼æœåŠ¡éƒ¨ç½²å¹³å° - Makefile

.PHONY: help deploy status rollback test clean

# é»˜è®¤ç›®æ ‡
help:
	@echo "åˆ†å¸ƒå¼æœåŠ¡éƒ¨ç½²å¹³å° - æ„å»ºå·¥å…·"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make deploy    éƒ¨ç½²æœåŠ¡åˆ°æ‰€æœ‰æœåŠ¡å™¨"
	@echo "  make status    æŸ¥çœ‹æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€"
	@echo "  make rollback  å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬"
	@echo "  make test      æµ‹è¯•æœåŠ¡å™¨è¿æ¥"
	@echo "  make config    åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶"
	@echo "  make clean     æ¸…ç†å¤‡ä»½å’Œæ—¥å¿—"
	@echo "  make help      æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ç¯å¢ƒå˜é‡:"
	@echo "  CONFIG_FILE=è‡ªå®šä¹‰é…ç½®æ–‡ä»¶è·¯å¾„"
	@echo "  LOG_LEVEL=DEBUG|INFO|WARN|ERROR"

# éƒ¨ç½²æœåŠ¡
deploy:
	@echo "ğŸš€ å¼€å§‹éƒ¨ç½²æœåŠ¡..."
	./deploy.sh deploy

# æŸ¥çœ‹çŠ¶æ€
status:
	@echo "ğŸ“Š æŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€..."
	./deploy.sh status

# å›æ»šæœåŠ¡
rollback:
	@echo "ğŸ”™ å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬..."
	./deploy.sh rollback

# æµ‹è¯•è¿æ¥
test:
	@echo "ğŸ”— æµ‹è¯•æœåŠ¡å™¨è¿æ¥..."
	./deploy.sh test

# åˆ›å»ºé…ç½®æ–‡ä»¶
config:
	@echo "âš™ï¸ åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶..."
	./deploy.sh config

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
	@if [ -f "deploy.log" ]; then \
		echo "å¤‡ä»½æ—¥å¿—æ–‡ä»¶..."; \
		mv deploy.log "deploy.log.$(date +%Y%m%d_%H%M%S)"; \
	fi
	@if [ -d "backups" ]; then \
		echo "æ¸…ç†æ—§å¤‡ä»½..."; \
		find backups -type f -name "*.tar.gz" -mtime +7 -delete; \
	fi
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å®‰è£…ä¾èµ–
install-deps:
	@echo "ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–..."
	@command -v apt-get >/dev/null 2>&1 && sudo apt-get install -y ssh rsync curl git || \
	command -v yum >/dev/null 2>&1 && sudo yum install -y ssh rsync curl git || \
	command -v brew >/dev/null 2>&1 && brew install ssh rsync curl git || \
	echo "âš ï¸  è¯·æ‰‹åŠ¨å®‰è£…: ssh, rsync, curl, git"

# éªŒè¯ç¯å¢ƒ
check-env:
	@echo "ğŸ” éªŒè¯éƒ¨ç½²ç¯å¢ƒ..."
	@command -v ssh >/dev/null 2>&1 || echo "âŒ ssh æœªå®‰è£…"
	@command -v rsync >/dev/null 2>&1 || echo "âŒ rsync æœªå®‰è£…"
	@command -v curl >/dev/null 2>&1 || echo "âŒ curl æœªå®‰è£…"
	@command -v git >/dev/null 2>&1 || echo "âŒ git æœªå®‰è£…"
	@[ -f "deploy.config" ] || echo "âš ï¸  é…ç½®æ–‡ä»¶ deploy.config ä¸å­˜åœ¨ï¼Œè¿è¡Œ: make config"
	@echo "âœ… ç¯å¢ƒæ£€æŸ¥å®Œæˆ"

# æŸ¥çœ‹æ—¥å¿—
logs:
	@echo "ğŸ“ æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—..."
	@if [ -f "deploy.log" ]; then \
		tail -50 deploy.log; \
	else \
		echo "æš‚æ— æ—¥å¿—æ–‡ä»¶"; \
	fi

# å¤‡ä»½ç®¡ç†
list-backups:
	@echo "ğŸ’¾ å¯ç”¨å¤‡ä»½åˆ—è¡¨:"
	@if [ -d "backups" ]; then \
		ls -lh backups/; \
	else \
		echo "æš‚æ— å¤‡ä»½"; \
	fi

# ç‰ˆæœ¬ä¿¡æ¯
version:
	@echo "åˆ†å¸ƒå¼æœåŠ¡éƒ¨ç½²å¹³å°"
	@echo "ç‰ˆæœ¬: 1.0.0"
	@echo "ä½œè€…: Walson"
	@echo "åˆ›å»ºæ—¶é—´: 2026-02-02"

# å®‰å…¨æ£€æŸ¥
security-check:
	@echo "ğŸ”’ å®‰å…¨æ£€æŸ¥..."
	@# æ£€æŸ¥é…ç½®æ–‡ä»¶æƒé™
	@if [ -f "deploy.config" ]; then \
		perms=$$(stat -c "%a" deploy.config); \
		if [ "$$perms" != "600" ]; then \
			echo "âš ï¸  é…ç½®æ–‡ä»¶æƒé™å»ºè®®è®¾ç½®ä¸º 600"; \
			chmod 600 deploy.config; \
		fi; \
	fi
	@# æ£€æŸ¥SSHå¯†é’¥æƒé™
	@if [ -f "$$HOME/.ssh/id_rsa" ]; then \
		perms=$$(stat -c "%a" $$HOME/.ssh/id_rsa); \
		if [ "$$perms" != "600" ]; then \
			echo "âš ï¸  SSHç§é’¥æƒé™å»ºè®®è®¾ç½®ä¸º 600"; \
		fi; \
	fi
	@echo "âœ… å®‰å…¨æ£€æŸ¥å®Œæˆ"

# åˆå§‹åŒ–é¡¹ç›®
init: install-deps config security-check
	@echo "âœ… é¡¹ç›®åˆå§‹åŒ–å®Œæˆ"
	@echo ""
	@echo "ä¸‹ä¸€æ­¥:"
	@echo "  1. ç¼–è¾‘ deploy.config é…ç½®æ–‡ä»¶"
	@echo "  2. è¿è¡Œ make test æµ‹è¯•è¿æ¥"
	@echo "  3. è¿è¡Œ make deploy å¼€å§‹éƒ¨ç½²"

# å®Œæ•´éƒ¨ç½²æµç¨‹
full-deploy: check-env test deploy status
	@echo "ğŸ‰ å®Œæ•´éƒ¨ç½²æµç¨‹å®Œæˆ!"