# Nginx负载均衡配置示例
# 将此配置放在 /etc/nginx/sites-available/demo-service
# 然后创建符号链接到 /etc/nginx/sites-enabled/

upstream demo_servers {
    # 负载均衡策略
    # least_conn;    # 最少连接数
    # ip_hash;      # IP哈希（会话保持）
    
    # 默认使用轮询
    server 服务器1_IP:3000;  # 例如：182.92.31.155:3000
    server 服务器2_IP:3000;  # 例如：152.136.16.77:3000
    
    # 可选的权重配置
    # server 服务器1_IP:3000 weight=3;  # 处理3倍流量
    # server 服务器2_IP:3000 weight=1;  # 处理1倍流量
}

server {
    listen 80;
    server_name demo.yourdomain.com;  # 或使用服务器IP
    
    # 访问日志
    access_log /var/log/nginx/demo-service.access.log;
    error_log /var/log/nginx/demo-service.error.log;
    
    location / {
        proxy_pass http://demo_servers;
        
        # 代理头设置
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 缓冲设置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }
    
    # 健康检查端点（可选）
    location /nginx-health {
        access_log off;
        return 200 "nginx is healthy\n";
        add_header Content-Type text/plain;
    }
}

# 健康检查配置（可选）
# 可以配置主动健康检查
# http {
#     upstream demo_servers {
#         zone backend 64k;
#         server 服务器1_IP:3000;
#         server 服务器2_IP:3000;
#         
#         # 健康检查
#         health_check interval=5s fails=3 passes=2;
#     }
# }